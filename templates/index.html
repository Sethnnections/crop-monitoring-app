<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTBE MRV System-NDVI</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        :root {
            --deep-green: #0a2e1a;
            --dark-green: #1a4d2e;
            --medium-green: #2e7d32;
            --light-green: #4f9d69;
            --yellow-green: #8bc34a;
            --accent-green: #3a7d44;
            --bright-green: #a5d6a7;
            --background-dark: #121e17;
            --background-light: #f5f9f6;
            --text-white: #ffffff;
            --text-light: #e0e0e0;
            --card-shadow: 0 8px 30px rgba(0, 40, 20, 0.12);
            --transition-all: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }
        
        body {
            background-color: var(--background-dark);
            font-family: 'Poppins', sans-serif;
            color: var(--text-light);
            overflow: hidden;
            min-height: 100vh;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--yellow-green);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--light-green);
        }
        
        /* Glow Effects */
        .glow-on-hover {
            transition: var(--transition-all);
        }
        .glow-on-hover:hover {
            box-shadow: 0 0 15px rgba(139, 195, 74, 0.5);
        }
        
        /* Dashboard Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--deep-green) 0%, var(--dark-green) 100%);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(139, 195, 74, 0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logo-container img {
            height: 50px;
            width: auto;
            transition: transform 0.5s ease, filter 0.5s ease;
            filter: drop-shadow(0 0 5px rgba(139, 195, 74, 0.5));
        }
        
        .logo-container:hover img {
            transform: rotate(5deg) scale(1.05);
            filter: drop-shadow(0 0 10px rgba(139, 195, 74, 0.8));
        }
        
        .header-title {
            font-weight: 600;
            color: var(--text-white);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.5px;
            position: relative;
        }
        
        .header-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 50%;
            height: 2px;
            background: var(--yellow-green);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .logo-container:hover .header-title::after {
            transform: scaleX(1);
        }
        
        /* Date Range Picker */
        .date-range-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(10, 46, 26, 0.6);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(139, 195, 74, 0.3);
            backdrop-filter: blur(5px);
            transition: var(--transition-all);
        }
        
        .date-range-container:hover {
            border-color: var(--yellow-green);
            box-shadow: 0 0 15px rgba(139, 195, 74, 0.2);
        }
        
        .date-range-container label {
            color: var(--bright-green);
            font-weight: 500;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        
        .date-range-container input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(139, 195, 74, 0.3);
            color: var(--text-white);
            border-radius: 8px;
            padding: 0.6rem;
            transition: var(--transition-all);
        }
        
        .date-range-container input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--yellow-green);
            box-shadow: 0 0 0 0.25rem rgba(139, 195, 74, 0.25);
            color: var(--text-white);
        }
        
        .date-range-container input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        #selected-period {
            font-weight: 500;
            color: var(--yellow-green);
            font-size: 0.95rem;
            text-align: center;
            margin-top: 0.5rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .logout-btn {
            background: linear-gradient(135deg, var(--medium-green) 0%, var(--dark-green) 100%);
            color: var(--text-white);
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-weight: 500;
            transition: var(--transition-all);
            box-shadow: 0 4px 15px rgba(26, 77, 46, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .logout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .logout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(26, 77, 46, 0.4);
        }
        
        .logout-btn:hover::before {
            left: 100%;
        }
        
        /* Dashboard Layout */
        .dashboard-row {
            height: calc(100vh - 120px);
            margin: 0;
        }
        
        /* Left Column - Controls */
        .scrollable-column {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 15px;
            padding-left: 5px;
        }
        
        /* Farmer Info Card */
        .farmer-info-card {
            background: linear-gradient(145deg, rgba(26, 77, 46, 0.8) 0%, rgba(10, 46, 26, 0.9) 100%);
            border-radius: 16px;
            padding: 1.8rem;
            margin-bottom: 1.8rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(139, 195, 74, 0.2);
            backdrop-filter: blur(5px);
            transition: var(--transition-all);
            position: relative;
            overflow: hidden;
        }
        
        .farmer-info-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 195, 74, 0.1) 0%, transparent 70%);
            transform: rotate(30deg);
            transition: var(--transition-all);
        }
        
        .farmer-info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 40, 20, 0.2);
            border-color: rgba(139, 195, 74, 0.4);
        }
        
        .farmer-info-card:hover::before {
            transform: rotate(45deg);
        }
        
        .farmer-name {
            font-size: 1.6rem;
            color: var(--text-white);
            margin-bottom: 0.8rem;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }
        
        .farmer-name::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--yellow-green);
            border-radius: 3px;
        }
        
        /* Farm Selector */
        .farm-selector {
            margin-top: 1.5rem;
        }
        
        .farm-selector label {
            color: var(--bright-green);
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(139, 195, 74, 0.3);
            color: var(--text-white);
            border-radius: 10px;
            padding: 0.7rem 1rem;
            transition: var(--transition-all);
            box-shadow: none;
        }
        
        .form-select:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--yellow-green);
            box-shadow: 0 0 0 0.25rem rgba(139, 195, 74, 0.25);
            color: var(--text-white);
        }
        
        .form-select option {
            background-color: var(--dark-green);
            color: var(--text-white);
        }
        
        /* Farm Details */
        .farm-details {
            margin-top: 1.5rem;
            background: rgba(0, 0, 0, 0.15);
            padding: 1.2rem;
            border-radius: 12px;
            border-left: 3px solid var(--yellow-green);
        }
        
        .detail-item {
            display: flex;
            margin-bottom: 0.8rem;
            align-items: center;
        }
        
        .detail-label {
            font-weight: 600;
            min-width: 100px;
            color: var(--bright-green);
            font-size: 0.9rem;
        }
        
        .detail-value {
            color: var(--text-white);
            font-weight: 500;
        }
        
        /* Cards */
        .card {
            background: linear-gradient(145deg, rgba(26, 77, 46, 0.8) 0%, rgba(10, 46, 26, 0.9) 100%);
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: var(--transition-all);
            margin-bottom: 1.8rem;
            border: 1px solid rgba(139, 195, 74, 0.2);
            backdrop-filter: blur(5px);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 40, 20, 0.25);
            border-color: rgba(139, 195, 74, 0.4);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--dark-green) 0%, var(--medium-green) 100%);
            color: var(--text-white);
            border-radius: 16px 16px 0 0 !important;
            padding: 1.2rem 1.8rem;
            border-bottom: 1px solid rgba(139, 195, 74, 0.3);
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .card-header i {
            color: var(--yellow-green);
            font-size: 1.2rem;
        }
        
        .card-body {
            padding: 1.8rem;
        }
        
        /* Toggle Switch */
        .form-check {
            display: flex;
            align-items: center;
            padding-left: 0;
            margin-bottom: 1.5rem;
        }
        
        .form-check-input {
            width: 48px;
            height: 24px;
            margin-right: 0.8rem;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            position: relative;
            transition: var(--transition-all);
        }
        
        .form-check-input:checked {
            background-color: var(--yellow-green);
        }
        
        .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(139, 195, 74, 0.25);
        }
        
        .form-check-label {
            color: var(--text-white);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .form-check-label i {
            color: var(--yellow-green);
            font-size: 1.2rem;
        }
        
        /* Slider */
        .opacity-control {
            margin-top: 2rem;
        }
        
        .opacity-control label {
            color: var(--text-white);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .opacity-control label i {
            color: var(--yellow-green);
            font-size: 1.2rem;
        }
        
        .form-range {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
        }
        
        .form-range::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            background: var(--yellow-green);
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: var(--transition-all);
        }
        
        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--yellow-green);
        }
        
        .opacity-value {
            color: var(--yellow-green);
            font-weight: 600;
            text-align: right;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        
        /* NDVI Legend */
        #ndvi-legend {
            margin-top: 1.5rem;
        }
        
        .legend-gradient {
            height: 200px;
            width: 100%;
            border-radius: 12px;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .legend-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, 
                #050505 0%, 
                #dbdbdb 25%, 
                #ff0000 40%, 
                #ff9900 60%, 
                #66e619 80%, 
                #1a801a 100%);
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            color: var(--text-white);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .legend-label {
            position: absolute;
            left: 110%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .legend-value {
            font-weight: 600;
            color: var(--yellow-green);
        }
        
        .legend-text {
            font-size: 0.7rem;
            color: var(--bright-green);
            margin-top: 2px;
        }
        
        /* Load Button */
        .btn-ndvi {
            background: linear-gradient(135deg, var(--yellow-green) 0%, var(--light-green) 100%);
            color: var(--dark-green);
            width: 100%;
            padding: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            transition: var(--transition-all);
            box-shadow: 0 4px 15px rgba(139, 195, 74, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn-ndvi::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }
        
        .btn-ndvi:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 195, 74, 0.4);
            color: var(--dark-green);
        }
        
        .btn-ndvi:hover::before {
            left: 100%;
        }
        
        .btn-ndvi i {
            font-size: 1.2rem;
        }
        
        /* Map Container */
        .map-container {
            height: calc(100vh - 120px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            position: relative;
            border: 1px solid rgba(139, 195, 74, 0.3);
            transition: var(--transition-all);
        }
        
        .map-container:hover {
            box-shadow: 0 15px 35px rgba(0, 40, 20, 0.25);
            border-color: rgba(139, 195, 74, 0.5);
        }
        
        .value-display {
            position: absolute;
            bottom: 25px;
            right: 25px;
            background: rgba(26, 77, 46, 0.9);
            padding: 0.7rem 1.2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            color: var(--text-white);
            font-weight: 500;
            border: 1px solid rgba(139, 195, 74, 0.3);
            backdrop-filter: blur(5px);
            transition: var(--transition-all);
        }
        
        .value-display:hover {
            background: rgba(26, 77, 46, 1);
            transform: translateY(-3px);
        }
        
        /* Loading Indicator */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 46, 26, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .loading-indicator .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--yellow-green);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1.5rem;
        }
        
        .loading-indicator p {
            color: var(--text-white);
            font-weight: 500;
            font-size: 1.2rem;
            text-align: center;
            max-width: 300px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem;
            }
            
            .date-range-container {
                width: 100%;
                flex-direction: column;
            }
            
            .dashboard-row {
                height: auto;
                flex-direction: column-reverse;
            }
            
            .scrollable-column {
                height: auto;
                max-height: 50vh;
                margin-top: 1.5rem;
            }
            
            .map-container {
                height: 60vh;
            }
        }
        
        /* Animation Classes */
        .animate-pop {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.95); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Pulse Animation */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(139, 195, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 195, 74, 0); }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header with logo, title, and logout -->
        <div class="dashboard-header animate__animated animate__fadeInDown">
            <div class="logo-container">
                <img src="{{ url_for('static', filename='img/logo.jpg') }}" alt="Logo" class="animate__animated animate__fadeInLeft">
                <h1 class="header-title animate__animated animate__fadeIn">
                    Farmer: {{ farmer.name }} {{ farmer.surname }}
                </h1>
            </div>
        
            <div class="date-range-container animate__animated animate__fadeIn">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="start-date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date">
                    </div>
                    <div class="col-md-4">
                        <label for="end-date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button id="apply-dates" class="btn btn-primary w-100 glow-on-hover">
                            <i class="bi bi-calendar-check"></i> Apply
                        </button>
                    </div>
                    <div class="col-12 mt-2">
                        <div id="selected-period" class="text-center"></div>
                    </div>
                </div>
            </div>
        
            <div class="user-info">
                <button class="logout-btn animate__animated animate__fadeIn">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
        

        <div class="row g-4 dashboard-row">
            <!-- Left Column - Controls (now scrollable) -->
            <div class="col-md-4 scrollable-column">
                <!-- Farmer Info Card -->
                <div class="farmer-info-card animate-pop" data-aos="fade-right">
                    <h3 class="farmer-name">{{ farmer.name }} {{ farmer.surname }}</h3>
                    
                    <!-- Farm Selector Dropdown -->
                    <div class="farm-selector">
                        <label for="farm-select" class="form-label">Select Farm:</label>
                        <select class="form-select" id="farm-select">
                            {% for farm in farms %}
                            <option value="{{ loop.index0 }}" 
                                    data-geojson='{
                                        "type": "FeatureCollection",
                                        "features": [{
                                            "type": "Feature",
                                            "properties": {
                                                "name": "{{ farm.name }}",
                                                "size": {{ farm.size }},
                                                "location": "{{ farm.location }}"
                                            },
                                            "geometry": {{ farm.boundary | tojson }}
                                        }]
                                    }'
                                    {% if loop.first %}selected{% endif %}>
                                {{ farm.name }} ({{ farm.size }} ha)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Farm Details -->
                    <div class="farm-details">
                        <div class="detail-item">
                            <span class="detail-label">Farm Name:</span>
                            <span id="farm-name" class="detail-value">{{ selected_farm.name }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location:</span>
                            <span id="farm-location" class="detail-value">{{ selected_farm.location }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Size:</span>
                            <span id="farm-size" class="detail-value">{{ selected_farm.size }} hectares</span>
                        </div>
                    </div>
                </div>

                <!-- Toggle Card -->
                <div class="card animate-pop" data-aos="fade-right" data-aos-delay="100">
                    <div class="card-header">
                        <i class="bi bi-layers"></i>
                        <h5 class="card-title mb-0">Layer Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="toggle-ndvi" checked>
                            <label class="form-check-label" for="toggle-ndvi">
                                <i class="bi bi-map"></i> Show NDVI Layer
                            </label>
                        </div>
                        <div class="opacity-control">
                            <label for="opacity-slider" class="form-label">
                                <i class="bi bi-brightness-high"></i> NDVI Opacity
                            </label>
                            <input type="range" class="form-range opacity-slider" id="opacity-slider" min="0"
                                max="1" step="0.1" value="0.6">
                            <div class="opacity-value">60%</div>
                        </div>
                    </div>
                </div>

                <!-- Legend Card -->
                <div class="card animate-pop" data-aos="fade-right" data-aos-delay="200">
                    <div class="card-header">
                        <i class="bi bi-palette"></i>
                        <h5 class="card-title mb-0">NDVI Legend</h5>
                    </div>
                    <div class="card-body">
                        <div id="ndvi-legend">
                            <div class="legend-gradient"></div>
                            <div class="legend-labels">
                                <span>-1.0</span>
                                <span>0</span>
                                <span>+1.0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Load Button Card -->
                <div class="card animate-pop" data-aos="fade-right" data-aos-delay="300">
                    <div class="card-body text-center">
                        <button id="load-ndvi" class="btn btn-ndvi pulse">
                            <i class="bi bi-cloud-arrow-down"></i> Load NDVI Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column - Map -->
            <div class="col-md-8">
                <div id="map" class="map-container animate__animated animate__fadeIn">
                    <div id="value-display" class="value-display">Hover over map to see values</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <!-- AOS Animation Library -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script>
        // Initialize AOS animation library
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        // Pass Flask variables to JavaScript
        const mapCenter = {{ center| tojson }};
        const geojsonData = {{ geojson| safe }};
        const farmerName = "{{ farmer.name }} {{ farmer.surname }}";
        let ndviLayer = null;
        let ndviImageData = null;
        
        // Initialize map with ArcGIS World Imagery
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.XYZ({
                        url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                        attributions: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([mapCenter[1], mapCenter[0]]),
                zoom: 12
            })
        });

        // Value display element
        const valueDisplay = document.getElementById('value-display');

        // Initialize date pickers with default values (current month)
        function initializeDatePickers() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('start-date').valueAsDate = firstDayOfMonth;
            document.getElementById('end-date').valueAsDate = today;
            
            updateSelectedPeriodDisplay();
        }
        
        // Update the selected period display text
        function updateSelectedPeriodDisplay() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (startDate && endDate) {
                const formattedStart = new Date(startDate).toLocaleDateString();
                const formattedEnd = new Date(endDate).toLocaleDateString();
                document.getElementById('selected-period').textContent = `Selected period: ${formattedStart} to ${formattedEnd}`;
            }
        }

        // Initialize date pickers when the page loads
        initializeDatePickers();
        
        // Add event listeners for date changes
        document.getElementById('start-date').addEventListener('change', updateSelectedPeriodDisplay);
        document.getElementById('end-date').addEventListener('change', updateSelectedPeriodDisplay);

        // Validate and process GeoJSON data
        function validateAndProcessGeoJSON(geojson) {
            try {
                if (!geojson || !geojson.type || geojson.type !== 'FeatureCollection') {
                    throw new Error('Invalid GeoJSON: Must be a FeatureCollection');
                }

                if (!geojson.features || !Array.isArray(geojson.features) || geojson.features.length === 0) {
                    throw new Error('Invalid GeoJSON: No features found');
                }

                // Check each feature's geometry type
                const validGeometries = ['Polygon', 'MultiPolygon'];
                for (const feature of geojson.features) {
                    if (!feature.geometry || !validGeometries.includes(feature.geometry.type)) {
                        throw new Error(`Invalid geometry type: Only Polygon and MultiPolygon are supported (found ${feature.geometry?.type})`);
                    }
                }

                return geojson;
            } catch (error) {
                console.error('GeoJSON validation error:', error);
                throw error;
            }
        }

        // Process the initial GeoJSON data
        let processedGeoJSON;
        try {
            processedGeoJSON = validateAndProcessGeoJSON(geojsonData);
        } catch (error) {
            alert('Error loading map: ' + error.message);
        }

        // Add GeoJSON layer with error handling
        let vectorSource;
        try {
            vectorSource = new ol.source.Vector({
                features: new ol.format.GeoJSON().readFeatures(processedGeoJSON, {
                    featureProjection: 'EPSG:3857',
                    dataProjection: 'EPSG:4326'
                })
            });
        } catch (error) {
            console.error('Error creating vector source:', error);
            alert('Error displaying boundary: ' + error.message);
        }

        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'rgba(139, 195, 74, 0.8)',
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(26, 77, 46, 0.2)'
                })
            }),
            name: 'farm-boundary'
        });

        map.addLayer(vectorLayer);

        // Fit view to GeoJSON extent with padding
        try {
            map.getView().fit(vectorSource.getExtent(), {
                padding: [50, 50, 50, 50],
                duration: 1000 // Smooth animation
            });
        } catch (error) {
            console.error('Error fitting view:', error);
        }

        // Farm selector functionality
        document.getElementById('farm-select').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const farmGeoJSON = JSON.parse(selectedOption.dataset.geojson);
            
            // Update farm details
            document.getElementById('farm-name').textContent = farmGeoJSON.features[0].properties.name;
            document.getElementById('farm-location').textContent = farmGeoJSON.features[0].properties.location;
            document.getElementById('farm-size').textContent = `${farmGeoJSON.features[0].properties.size} hectares`;
            
            // Update the map with the new farm boundary
            updateMapWithNewFarm(farmGeoJSON);
        });
        
        function updateMapWithNewFarm(geojson) {
            // Remove existing vector layer if it exists
            map.getLayers().forEach(layer => {
                if (layer.get('name') === 'farm-boundary') {
                    map.removeLayer(layer);
                }
            });
            
            // Create new vector source and layer
            const vectorSource = new ol.source.Vector({
                features: new ol.format.GeoJSON().readFeatures(geojson, {
                    featureProjection: 'EPSG:3857',
                    dataProjection: 'EPSG:4326'
                })
            });
            
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'rgba(139, 195, 74, 0.8)',
                        width: 3
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(26, 77, 46, 0.2)'
                    })
                }),
                name: 'farm-boundary'
            });
            
            map.addLayer(vectorLayer);
            
            // Fit view to the new farm's extent
            map.getView().fit(vectorSource.getExtent(), {
                padding: [50, 50, 50, 50],
                duration: 1000
            });
            
            // Clear any existing NDVI data
            if (ndviLayer) {
                map.removeLayer(ndviLayer);
                ndviLayer = null;
            }
            ndviImageData = null;
            document.getElementById('toggle-ndvi').checked = false;
            document.getElementById('ndvi-legend').style.display = 'none';
        }

        // Enhanced NDVI button click handler with date range
        document.getElementById('load-ndvi').addEventListener('click', function () {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.innerHTML = '<div class="spinner"></div><p>Processing NDVI data...</p>';
            document.body.appendChild(loadingIndicator);

            // Get current farm's GeoJSON
            const selectedOption = document.getElementById('farm-select').options[document.getElementById('farm-select').selectedIndex];
            const currentGeoJSON = JSON.parse(selectedOption.dataset.geojson);

            // Get date range values
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Validate dates
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Load NDVI Data';
                document.body.removeChild(loadingIndicator);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date');
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Load NDVI Data';
                document.body.removeChild(loadingIndicator);
                return;
            }

            // Add dates to the GeoJSON payload
            currentGeoJSON.start_date = startDate;
            currentGeoJSON.end_date = endDate;

            // Validate GeoJSON before sending
            let validGeoJSON;
            try {
                validGeoJSON = validateAndProcessGeoJSON(currentGeoJSON);
            } catch (error) {
                console.error('GeoJSON validation failed:', error);
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Load NDVI Data';
                document.body.removeChild(loadingIndicator);
                alert('Invalid boundary: ' + error.message);
                return;
            }

            fetch('/get-ndvi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(validGeoJSON)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Clean up UI
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Load NDVI Data';
                    document.body.removeChild(loadingIndicator);

                    if (data.status === 'success') {
                        // Remove previous NDVI layer if exists
                        if (ndviLayer) {
                            map.removeLayer(ndviLayer);
                            ndviLayer = null;
                        }

                        // Store the image data for hover functionality
                        ndviImageData = data.image;

                        // Process the NDVI image data
                        processNdviImage(data.image, vectorSource)
                            .then(imageLayer => {
                                ndviLayer = imageLayer;
                                map.addLayer(ndviLayer);

                                // Zoom to the NDVI layer with animation
                                map.getView().fit(vectorSource.getExtent(), {
                                    padding: [50, 50, 50, 50],
                                    duration: 1000
                                });

                                // Show legend by default
                                document.getElementById('ndvi-legend').style.display = 'block';
                                document.getElementById('toggle-ndvi').checked = true;
                            })
                            .catch(error => {
                                console.error('NDVI processing error:', error);
                                alert('Error displaying NDVI: ' + error.message);
                            });
                    } else {
                        throw new Error(data.message || 'Unknown error occurred');
                    }
                })
                .catch(error => {
                    console.error('NDVI request failed:', error);
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Load NDVI Data';
                    document.body.removeChild(loadingIndicator);
                    alert('NDVI request failed: ' + error.message);
                });
        });

        /**
         * Processes NDVI image data and creates an OpenLayers image layer
         * @param {Array} imageData - 3D array of image data from server
         * @param {ol.source.Vector} source - Vector source for extent reference
         * @returns {Promise<ol.layer.Image>} Promise resolving to the image layer
         */
        function processNdviImage(imageData, source) {
            return new Promise((resolve, reject) => {
                try {
                    if (!imageData || !Array.isArray(imageData) || imageData.length === 0) {
                        throw new Error('No image data received');
                    }

                    // Get dimensions
                    const height = imageData.length;
                    const width = imageData[0].length;

                    // Flatten the 3D array into a 1D array of RGBA values
                    const flatPixels = [];
                    for (const row of imageData) {
                        if (!Array.isArray(row) || row.length !== width) {
                            throw new Error('Inconsistent image data structure');
                        }
                        for (const pixel of row) {
                            if (!Array.isArray(pixel) || pixel.length !== 4) {
                                throw new Error('Invalid pixel format');
                            }
                            flatPixels.push(...pixel);
                        }
                    }

                    // Create canvas and context
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // Create ImageData
                    const imageArray = new Uint8ClampedArray(flatPixels);
                    const imageDataObj = new ImageData(imageArray, width, height);

                    // Draw on canvas
                    ctx.putImageData(imageDataObj, 0, 0);

                    // Create image layer
                    const extent = source.getExtent();
                    const imageUrl = canvas.toDataURL('image/png');

                    const imageLayer = new ol.layer.Image({
                        source: new ol.source.ImageStatic({
                            url: imageUrl,
                            imageExtent: extent,
                            projection: 'EPSG:3857'
                        }),
                        opacity: 0.6
                    });

                    resolve(imageLayer);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Checkbox toggle for NDVI layer
        document.getElementById('toggle-ndvi').addEventListener('change', function () {
            if (ndviLayer) {
                if (this.checked) {
                    map.addLayer(ndviLayer);
                    document.getElementById('ndvi-legend').style.display = 'block';
                } else {
                    map.removeLayer(ndviLayer);
                    document.getElementById('ndvi-legend').style.display = 'none';
                }
            }
        });

        // Opacity slider control
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValue = document.querySelector('.opacity-value');

        opacitySlider.addEventListener('input', function () {
            const opacity = parseFloat(this.value);
            opacityValue.textContent = `${Math.round(opacity * 100)}%`;

            if (ndviLayer) {
                ndviLayer.setOpacity(opacity);
            }
        });

        // Mouse move handler for value display
        map.on('pointermove', function (evt) {
            if (!ndviImageData || !ndviLayer || !document.getElementById('toggle-ndvi').checked) {
                valueDisplay.style.display = 'none';
                return;
            }

            const coordinate = evt.coordinate;
            const extent = ndviLayer.getSource().getImageExtent();
            const resolution = map.getView().getResolution();

            // Check if the coordinate is within the NDVI image extent
            if (!ol.extent.containsCoordinate(extent, coordinate)) {
                valueDisplay.style.display = 'none';
                return;
            }

            // Calculate pixel position in the image
            const width = ndviImageData[0].length;
            const height = ndviImageData.length;

            const x = Math.floor((coordinate[0] - extent[0]) / (extent[2] - extent[0]) * width);
            const y = Math.floor((extent[3] - coordinate[1]) / (extent[3] - extent[1]) * height);

            // Ensure we're within bounds
            if (x >= 0 && x < width && y >= 0 && y < height) {
                const pixel = ndviImageData[y][x];

                // Calculate NDVI value from RGBA (assuming server sends NDVI encoded in RGBA)
                // This calculation depends on how your server encodes NDVI values in the image
                // Here's a common approach where NDVI is encoded in the red channel
                const ndviValue = (pixel[0] / 255 * 2) - 1; // Scale from [0,255] to [-1,1]

                valueDisplay.textContent = `NDVI: ${ndviValue.toFixed(4)}`;
                valueDisplay.style.display = 'block';
            } else {
                valueDisplay.style.display = 'none';
            }
        });

        // Hide value display when mouse leaves map
        map.getViewport().addEventListener('mouseout', function () {
            valueDisplay.style.display = 'none';
        });

        // Add NDVI legend
        createNdviLegend();

        /**
         * Creates and styles the NDVI legend with enhanced visualization
         */
        function createNdviLegend() {
            const legend = document.getElementById('ndvi-legend');

            // Enhanced color gradient with more stops for better visualization
            const gradientStops = [
                { color: '#050505', value: -1.0, label: 'Excellent Health'},
                { color: '#dbdbdb', value: -0.7, label: 'Good Health' },
                { color: '#ff0000', value: -0.5, label: 'Moderate Health' },
                { color: '#ff9900', value: 0.5, label: 'Highly Stressed' },
                { color: '#66e619', value: 0.7, label: 'Bare Soil'},
                { color: '#1a801a', value: 1.0, label: 'No Data/Water' },
            ];

            // Create gradient string
            let gradientString = 'linear-gradient(to bottom, ';
            gradientStops.forEach((stop, index) => {
                const position = ((stop.value + 1) / 2) * 100; // Scale from [-1,1] to [0,100]
                gradientString += `${stop.color} ${position}%`;
                if (index < gradientStops.length - 1) {
                    gradientString += ', ';
                }
            });

            // Apply to legend
            const gradientElement = legend.querySelector('.legend-gradient');
            gradientElement.style.background = gradientString;

            // Add value markers and labels
            const labelsContainer = legend.querySelector('.legend-labels');
            labelsContainer.innerHTML = '';

            gradientStops.forEach(stop => {
                if (stop.label) {
                    const position = ((stop.value + 1) / 2) * 100;
                    const labelElement = document.createElement('div');
                    labelElement.className = 'legend-label';
                    labelElement.style.bottom = `${position}%`;
                    labelElement.innerHTML = `<span class="legend-value">${stop.value.toFixed(2)}</span>
                                            <span class="legend-text">${stop.label}</span>`;
                    labelsContainer.appendChild(labelElement);
                }
            });
        }

        // Logout button functionality
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                // Add logout functionality here
                window.location.href = '/logout';
            }
        });

        // Apply dates button functionality
        document.getElementById('apply-dates').addEventListener('click', function() {
            // This just updates the display - the actual dates are used when loading NDVI
            updateSelectedPeriodDisplay();
        });
    </script>
</body>
</html>